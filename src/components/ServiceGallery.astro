
---
import { Image } from 'astro:assets';
import { getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  images: (string | ImageMetadata)[];
  title: string;
}

const { images, title } = Astro.props;

const galleryId = `gallery-${Math.random().toString(36).substr(2, 9)}`;

const processedImages = await Promise.all(images.map(async (img, index) => {
  if (typeof img === 'string') {
    return { 
      id: index,
      full: img, 
      thumb: img, 
      low: img,
      w: 0, 
      h: 0,
      isRemote: true 
    };
  }
  
  const full = await getImage({ src: img, width: 1280, format: 'jpeg', quality: 'mid' });
  const thumb = await getImage({ src: img, width: 300, format: 'jpeg', quality: 'low' });
  // Generate a lower quality version for "Low Memory" mode or poor connection
  const low = await getImage({ src: img, width: 800, format: 'jpeg', quality: 'low' });

  return {
    id: index,
    full: full.src,
    thumb: thumb.src,
    w: full.attributes.width,
    h: full.attributes.height,
    isRemote: false
  };
}));
---

<link rel="stylesheet" href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css">

<div class="py-12 service-gallery-root pswp-gallery" id={galleryId}>
  <h3 class="text-2xl font-bold mb-8 text-center text-white" data-aos="fade-up">{title}</h3>
  
  <!-- Image Grid -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-aos="fade-up" data-aos-delay="100">
    {processedImages.map((img, index) => (
      <a 
        href={img.full}
        data-pswp-width={img.w}
        data-pswp-height={img.h}
        target="_blank"
        class="gallery-trigger relative group overflow-hidden rounded-xl aspect-square w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary block"
        aria-label={`View image ${index + 1}`}
      >
        <img 
          src={img.thumb} 
          alt={`Gallery image ${index + 1}`}
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
          loading="lazy"
        />
        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300">
          <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white drop-shadow-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
            </svg>
          </div>
        </div>
      </a>
    ))}
  </div>
</div>

<script>
import PhotoSwipeLightbox from 'photoswipe/lightbox';
import 'photoswipe/style.css';

const initLightbox = () => {
  const galleries = document.querySelectorAll('.service-gallery-root');
  
  galleries.forEach(gallery => {
    const lightbox = new PhotoSwipeLightbox({
      gallery: gallery,
      children: 'a',
      pswpModule: () => import('photoswipe'),
      
      // Optimization settings
      wheelToZoom: true,
      bgOpacity: 0.9,
      showHideAnimationType: 'fade',
      
      // Memory management: destroy immediately on close to free RAM
      returnFocus: false,
      paddingFn: (viewportSize) => {
        return {
          top: 0, bottom: 0, left: 0, right: 0
        };
      }
    });
    
    lightbox.init();
  });
};

// Initialize on load and after View Transitions
initLightbox();
document.addEventListener('astro:after-swap', initLightbox);
</script>
