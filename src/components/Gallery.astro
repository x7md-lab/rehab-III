---
import { defaultLang } from '../i18n/ui';
import { Image } from 'astro:assets';

import img1 from '../assets/gallery_full/FJR09968.jpg';
import img2 from '../assets/gallery_full/RRW09158.JPG';
import img3 from '../assets/gallery_full/HSN09855.jpg';
import img4 from '../assets/gallery_full/RRW09192.JPG';
import img5 from '../assets/gallery_full/DSC09962.jpg';
import img6 from '../assets/gallery_full/DSC09386.JPG';
import img7 from '../assets/gallery_full/DSC00147.jpg';

const currentLocale = Astro.currentLocale || defaultLang;
const isRtl = currentLocale === 'ar';

const images = [img1, img2, img3, img4, img5, img6, img7];
---

<div id="gallery" class="h-full rounded-3xl overflow-hidden relative group bg-black/30 backdrop-blur-xl border border-white/10 p-4" data-aos="fade-up">
    <div class="relative h-full rounded-2xl overflow-hidden" dir={isRtl ? 'rtl' : 'ltr'}>
      <!-- Prev Button -->
      <button 
        class={`embla__prev absolute top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white/80 shadow-md flex items-center justify-center hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover:opacity-100 ${isRtl ? 'right-4' : 'left-4'}`}
        aria-label="Previous slide"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class={`h-6 w-6 ${isRtl ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <!-- Next Button -->
      <button 
        class={`embla__next absolute top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white/80 shadow-md flex items-center justify-center hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover:opacity-100 ${isRtl ? 'left-4' : 'right-4'}`}
        aria-label="Next slide"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class={`h-6 w-6 ${isRtl ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <div class="embla overflow-hidden cursor-grab active:cursor-grabbing h-full">
        <div class="embla__container flex -ms-4 h-full">
          {images.map((image, index) => (
            <div class="embla__slide flex-[0_0_100%] min-w-0 ps-4 h-full">
              <div class="relative group overflow-hidden rounded-xl shadow-lg h-full">
                <Image 
                  src={image} 
                  alt={`Rehab Gallery Image ${index + 1}`} 
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                  widths={[320, 640, 960]}
                  sizes="(max-width: 768px) 100vw, 50vw"
                  quality="low"
                  format="jpeg"
                  loading="lazy"
                  decoding="async"
                />
                <div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition-colors duration-300"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
    
    <!-- Dots Navigation - Absolute positioned at bottom -->
    <div class="embla__dots absolute bottom-8 left-0 right-0 flex justify-center gap-2 z-20"></div>
  </div>

<script>
  import EmblaCarousel from 'embla-carousel'
  import Autoplay from 'embla-carousel-autoplay'

  const emblaNode = document.querySelector('.embla') as HTMLElement
  const dotsNode = document.querySelector('.embla__dots') as HTMLElement
  const prevBtn = document.querySelector('.embla__prev') as HTMLElement
  const nextBtn = document.querySelector('.embla__next') as HTMLElement

  if (emblaNode) {
    // Get direction from the parent wrapper or the embla node itself if it had it
    const wrapper = emblaNode.closest('[dir]')
    const direction = (wrapper && wrapper.getAttribute('dir') === 'rtl') ? 'rtl' : 'ltr'
    
    const options = { loop: true, align: 'start', direction: direction as 'ltr' | 'rtl' }
    const plugins = [Autoplay({ delay: 4000, stopOnInteraction: false })]
    //@ts-expect-error
    const emblaApi = EmblaCarousel(emblaNode, options, plugins)

    // Dots Logic
    if (dotsNode) {
      const addDots = () => {
        dotsNode.innerHTML = ''
        emblaApi.scrollSnapList().forEach((_, index) => {
          const dot = document.createElement('button')
          dot.classList.add('embla__dot', 'w-3', 'h-3', 'rounded-full', 'bg-gray-300', 'transition-all', 'duration-300', 'hover:bg-primary/60')
          dot.setAttribute('aria-label', `Go to slide ${index + 1}`)
          dot.addEventListener('click', () => emblaApi.scrollTo(index))
          dotsNode.appendChild(dot)
        })
      }

      const selectDot = () => {
        const selected = emblaApi.selectedScrollSnap()
        const dots = dotsNode.querySelectorAll('.embla__dot')
        dots.forEach((dot, index) => {
          if (index === selected) {
            dot.classList.remove('bg-gray-300')
            dot.classList.add('bg-gold', 'w-6')
          } else {
            dot.classList.add('bg-gray-300')
            dot.classList.remove('bg-gold', 'w-6')
          }
        })
      }

      emblaApi.on('init', addDots)
      emblaApi.on('reInit', addDots)
      emblaApi.on('init', selectDot)
      emblaApi.on('reInit', selectDot)
      emblaApi.on('select', selectDot)
    }

    // Arrows Logic
    if (prevBtn && nextBtn) {
      prevBtn.addEventListener('click', () => emblaApi.scrollPrev())
      nextBtn.addEventListener('click', () => emblaApi.scrollNext())
    }

    // Manual Virtualization for Memory Management
    const manageMemory = () => {
      if (!emblaApi) return;
      const slides = emblaApi.slideNodes();
      const slidesInView = emblaApi.slidesInView();
      
      slides.forEach((slide, index) => {
        const img = slide.querySelector('img');
        if (!img) return;

        // Check if slide is in view or adjacent (buffer of 1)
        const isVisible = slidesInView.includes(index);
        const isAdjacent = slidesInView.includes(index - 1) || slidesInView.includes(index + 1);

        if (isVisible || isAdjacent) {
           if (img.style.visibility === 'hidden') {
             img.style.visibility = 'visible';
             // Force re-decode if needed, though browser usually handles this
             if (img.dataset.src) {
                // If we implemented src swapping, we would restore it here
             }
           }
        } else {
           // Hide off-screen images to free GPU texture memory
           img.style.visibility = 'hidden';
        }
      });
    };

    emblaApi.on('select', manageMemory);
    emblaApi.on('scroll', manageMemory); // Aggressive check during scroll
    emblaApi.on('init', manageMemory);
  }
</script>
