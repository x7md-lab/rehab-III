---
import { defaultLang } from '../i18n/ui';
import { getImage } from 'astro:assets';

import img1 from '../assets/gallery_full/FJR09968.jpg';
import img2 from '../assets/gallery_full/RRW09158.JPG';
import img3 from '../assets/gallery_full/HSN09855.jpg';
import img4 from '../assets/gallery_full/RRW09192.JPG';
import img5 from '../assets/gallery_full/DSC09962.jpg';
import img6 from '../assets/gallery_full/DSC09386.JPG';
import img7 from '../assets/gallery_full/DSC00147.jpg';

const currentLocale = Astro.currentLocale || defaultLang;
const isRtl = currentLocale === 'ar';

const rawImages = [img1, img2, img3, img4, img5, img6, img7];
const galleryId = `main-gallery-${Math.random().toString(36).substr(2, 9)}`;

const processedImages = await Promise.all(rawImages.map(async (img, index) => {
  const full = await getImage({ src: img, width: 1280, format: 'jpeg', quality: 'mid' });
  const thumb = await getImage({ src: img, width: 640, format: 'jpeg', quality: 'low' });

  return {
    id: index,
    full: full.src,
    thumb: thumb.src,
    w: full.attributes.width,
    h: full.attributes.height,
    original: img
  };
}));
---

<div id={galleryId} class="main-gallery-root pswp-gallery h-full rounded-3xl overflow-hidden relative group bg-black/30 backdrop-blur-xl border border-white/10 p-4" data-aos="fade-up">
    <div class="relative h-full rounded-2xl overflow-hidden" dir={isRtl ? 'rtl' : 'ltr'}>
      <!-- Prev Button -->
      <button 
        class={`embla__prev absolute top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white/80 shadow-md flex items-center justify-center hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover:opacity-100 ${isRtl ? 'right-4' : 'left-4'}`}
        aria-label="Previous slide"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class={`h-6 w-6 ${isRtl ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <!-- Next Button -->
      <button 
        class={`embla__next absolute top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white/80 shadow-md flex items-center justify-center hover:bg-primary hover:text-white transition-all duration-300 opacity-0 group-hover:opacity-100 ${isRtl ? 'left-4' : 'right-4'}`}
        aria-label="Next slide"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class={`h-6 w-6 ${isRtl ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <div class="embla overflow-hidden cursor-grab active:cursor-grabbing h-full">
        <div class="embla__container flex -ms-4 h-full">
          {processedImages.map((image, index) => (
            <div class="embla__slide flex-[0_0_100%] min-w-0 ps-4 h-full">
              <a 
                href={image.full}
                data-pswp-width={image.w}
                data-pswp-height={image.h}
                target="_blank"
                class="relative group overflow-hidden rounded-xl shadow-lg h-full block"
              >
                <img 
                  src={image.thumb} 
                  alt={`Rehab Gallery Image ${index + 1}`} 
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition-colors duration-300"></div>
                <!-- Zoom Icon Overlay -->
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                    <div class="bg-black/50 p-3 rounded-full text-white backdrop-blur-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                        </svg>
                    </div>
                </div>
              </a>
            </div>
          ))}
        </div>
      </div>
    </div>
    
    <!-- Dots Navigation - Absolute positioned at bottom -->
    <div class="embla__dots absolute bottom-8 left-0 right-0 flex justify-center gap-2 z-20"></div>
  </div>

<script>
  import EmblaCarousel from 'embla-carousel'
  import Autoplay from 'embla-carousel-autoplay'
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  const initGallery = () => {
      // 1. Initialize Embla Carousel
      const emblaNode = document.querySelector('.embla') as HTMLElement
      const dotsNode = document.querySelector('.embla__dots') as HTMLElement
      const prevBtn = document.querySelector('.embla__prev') as HTMLElement
      const nextBtn = document.querySelector('.embla__next') as HTMLElement

      if (emblaNode) {
        const wrapper = emblaNode.closest('[dir]')
        const direction = (wrapper && wrapper.getAttribute('dir') === 'rtl') ? 'rtl' : 'ltr'
        
        const options = { loop: true, align: 'start', direction: direction as 'ltr' | 'rtl' }
        const plugins = [Autoplay({ delay: 4000, stopOnInteraction: false })]
        //@ts-expect-error
        const emblaApi = EmblaCarousel(emblaNode, options, plugins)

        // Dots Logic
        if (dotsNode) {
          const addDots = () => {
            dotsNode.innerHTML = ''
            emblaApi.scrollSnapList().forEach((_, index) => {
              const dot = document.createElement('button')
              dot.classList.add('embla__dot', 'w-3', 'h-3', 'rounded-full', 'bg-gray-300', 'transition-all', 'duration-300', 'hover:bg-primary/60')
              dot.setAttribute('aria-label', `Go to slide ${index + 1}`)
              dot.addEventListener('click', () => emblaApi.scrollTo(index))
              dotsNode.appendChild(dot)
            })
          }

          const updateDots = () => {
             const dots = dotsNode.querySelectorAll('.embla__dot')
             dots.forEach((dot, index) => {
                if (index === emblaApi.selectedScrollSnap()) {
                   dot.classList.remove('bg-gray-300')
                   dot.classList.add('bg-primary', 'w-8')
                } else {
                   dot.classList.add('bg-gray-300')
                   dot.classList.remove('bg-primary', 'w-8')
                }
             })
          }

          emblaApi.on('init', addDots)
          emblaApi.on('select', updateDots)
          emblaApi.on('reInit', addDots)
          emblaApi.on('reInit', updateDots)
          
          addDots()
          updateDots()
        }
        
        // Buttons
        if (prevBtn) prevBtn.addEventListener('click', () => emblaApi.scrollPrev())
        if (nextBtn) nextBtn.addEventListener('click', () => emblaApi.scrollNext())
      }

      // 2. Initialize PhotoSwipe
      const lightbox = new PhotoSwipeLightbox({
        gallery: '.main-gallery-root',
        children: 'a',
        pswpModule: () => import('photoswipe'),
        wheelToZoom: true,
        bgOpacity: 0.9,
        showHideAnimationType: 'fade',
        returnFocus: false
      });
      lightbox.init();
  };

  // Run on load and View Transitions
  initGallery();
  document.addEventListener('astro:after-swap', initGallery);
</script>
