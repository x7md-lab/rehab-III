
---
import Layout from '@/layouts/Layout.astro';
import ServiceHero from '@/components/ServiceHero.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { ui } from '@/i18n/ui';
import type { ProjectData } from '@/lib/projectData';
import { SITE } from '@/config/site';
import { defineWebPage, defineLocalBusiness, defineBreadcrumb } from '@unhead/schema-org';

interface Props {
  project: ProjectData;
}

const { project } = Astro.props;

const currentLocale = (Astro.currentLocale || 'ar') as keyof typeof ui;
const t = ui[currentLocale];
const isRtl = currentLocale === 'ar';
const homeUrl = isRtl ? `${SITE.url}/` : `${SITE.url}/en`;

// Get translated content
const title = t[project.titleKey as keyof typeof t];
const description = t[project.descKey as keyof typeof t];
const content = t[project.contentKey as keyof typeof t];

const videoId = project.mainVideo;

// Schema
const schemaNodes = [
  defineWebPage({
    name: title,
    description: description,
    inLanguage: currentLocale,
  }),
  defineLocalBusiness({
    name: t['hero.title_company'],
    image: '/logowhte.svg',
    makesOffer: [
      { 
        "@type": "Offer", 
        "itemOffered": { 
          "@type": "Service", 
          "name": title,
          "description": content,
          "image": typeof project.heroImage === 'string' ? project.heroImage : project.heroImage.src
        } 
      }
    ]
  }),
  defineBreadcrumb({
    itemListElement: [
      { name: t['nav.home'], item: homeUrl },
      { name: t['nav.projects'], item: isRtl ? `${SITE.url}/projects` : `${SITE.url}/en/projects` },
      { name: title, item: `${SITE.url}${Astro.url.pathname}` }
    ]
  })
];
---

<Layout title={`${title} | ${t['hero.title_company']}`} schemaNodes={schemaNodes}>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" slot="head" />
  <script is:inline src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js" slot="head"></script>

  <Header />
  
  <main class="pb-20">
    <ServiceHero 
      title={title} 
      subtitle={description} 
      image={project.heroImage} 
    />

    <div class="container mx-auto px-4 mt-16">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8" data-aos="fade-up">
          <div class="bg-white/5 backdrop-blur-sm rounded-3xl p-8 border border-white/10 shadow-lg">
            <h2 class="text-3xl font-bold mb-6 text-gold">{title}</h2>
            
            {videoId && (
              <div class="space-y-6">
                <!-- Main Video Player -->
                <div class="rounded-xl overflow-hidden shadow-2xl aspect-video bg-black">
                  <div class="plyr__video-embed w-full h-full" id="player">
                    <iframe
                      src={`https://www.youtube.com/embed/${videoId}?origin=https://plyr.io&iv_load_policy=3&modestbranding=1&playsinline=1&showinfo=0&rel=0&enablejsapi=1`}
                      allowfullscreen
                      allowtransparency
                      allow="autoplay"
                    ></iframe>
                  </div>
                </div>

                <!-- Sub Videos Grid -->
                {project.subVideos && project.subVideos.length > 0 && (
                  <div>
                    <h3 class="text-xl font-semibold text-white mb-4 border-b border-white/10 pb-2">
                      {isRtl ? 'مقاطع ذات صلة' : 'Related Videos'}
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                      {project.subVideos.map((subId, index) => (
                        <button 
                          class="sub-video-trigger group relative aspect-video rounded-lg overflow-hidden cursor-pointer focus:outline-none focus:ring-2 focus:ring-gold ring-offset-2 ring-offset-transparent transition-all hover:scale-[1.02]"
                          data-video-id={subId}
                          aria-label={isRtl ? `تشغيل المقطع ${index + 1}` : `Play video ${index + 1}`}
                        >
                          <img 
                            src={`https://img.youtube.com/vi/${subId}/hqdefault.jpg`} 
                            alt={`Video thumbnail ${index + 1}`} 
                            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-90 group-hover:opacity-100"
                            loading="lazy"
                          />
                          <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors duration-300"></div>
                          
                          {/* Play Icon Overlay */}
                          <div class="absolute inset-0 flex items-center justify-center">
                            <div class="bg-primary/80 p-2 rounded-full text-white backdrop-blur-sm group-hover:bg-gold group-hover:text-primary transition-colors transform group-hover:scale-110">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            <div class="prose prose-lg prose-invert max-w-none mt-8 pt-8 border-t border-white/10">
              <p class="text-gray-200 leading-relaxed whitespace-pre-line">
                {content}
              </p>
            </div>
          </div>
        </div>

        <!-- Sidebar / Contact -->
        <div class="lg:col-span-1 space-y-6">
          <div class="sticky top-24" data-aos="fade-up" data-aos-delay="200">
             <div class="bg-primary/90 backdrop-blur-md rounded-3xl p-8 text-white shadow-xl">
                <h3 class="text-2xl font-bold mb-6">{t['footer.contact_us']}</h3>
                <p class="mb-6 text-gray-200">{isRtl ? 'تواصل معنا لمزيد من المعلومات عن هذا المشروع' : 'Contact us for more information about this project'}</p>
                
                <div class="space-y-4">
                  <a href={`tel:${t['contact.phone_value']}`} class="flex items-center gap-4 p-3 rounded-xl bg-white/10 hover:bg-white/20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    <span dir="ltr">{t['contact.phone_value']}</span>
                  </a>
                  
                  <a href={`mailto:${t['contact.email_value']}`} class="flex items-center gap-4 p-3 rounded-xl bg-white/10 hover:bg-white/20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>{t['contact.email_value']}</span>
                  </a>
                </div>

                <div class="mt-8 pt-6 border-t border-white/20">
                  <a href="/#contact" class="block w-full text-center bg-gold text-primary font-bold py-3 rounded-full hover:bg-white transition-colors shadow-lg">
                    {t['nav.contact']}
                  </a>
                </div>
             </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <Footer />

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const player = new Plyr('#player', {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
        youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3, modestbranding: 1 }
      });

      // Sub-video click handler
      const subVideos = document.querySelectorAll('.sub-video-trigger');
      subVideos.forEach(btn => {
        btn.addEventListener('click', () => {
          const videoId = btn.getAttribute('data-video-id');
          if (videoId && player) {
            // Update Plyr source
            player.source = {
              type: 'video',
              sources: [
                {
                  src: videoId,
                  provider: 'youtube',
                },
              ],
            };
            player.play();
            
            // Scroll to player smoothly
            const playerElement = document.getElementById('player');
            if (playerElement) {
              playerElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
      });
    });
  </script>
</Layout>
